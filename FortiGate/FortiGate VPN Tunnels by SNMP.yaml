zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 36bff6c29af64692839d077febfc7079
      name: 'Templates/Network devices'
  templates:
    - uuid: 1f38deb487fc4a8d965e407ba7c52472
      template: 'FortiGate VPN Tunnels by SNMP'
      name: 'FortiGate VPN Tunnels by SNMP'
      description: |
        The template for monitoring FortiGate firewall by SNMP.
        
        MIBs used:
        HOST-RESOURCES-MIB
        FORTINET-FORTIGATE-MIB
        FORTINET-CORE-MIB
        SNMPv2-MIB
        IF-MIB
        
        Generated by official Zabbix template tool "Templator" 2.0.0
      groups:
        - name: 'Templates/Network devices'
      discovery_rules:
        - uuid: 6b3e7f58c9d54c31b8c195a900ecc73f
          name: 'VPN tunnels discovery'
          type: SNMP_AGENT
          snmp_oid: 'discovery[{#IFPHASE1NAME},1.3.6.1.4.1.12356.101.12.2.2.1.2]'
          key: vpn.tun.discovery
          delay: 1h
          lifetime: 3h
          enabled_lifetime_type: DISABLE_NEVER
          description: 'Discovering interfaces from IF-MIB.'
          item_prototypes:
            - uuid: ead0da6e0b4c4218a42090668a18bde1
              name: 'Tunnel {#IFPHASE1NAME}'
              type: EXTERNAL
              key: 'forti_vpn_status_v2.sh["-i","{HOST.IP}", "-c","{$SNMP_COMMUNITY}","-n","{#IFPHASE1NAME}","-a","{$SNMP.V3.PROTOCOL}","-A","{$SNMP.V3.PASSPHRASE}","-l","{$SNMP.V3.LEVEL}","-u","{$SNMP.V3.USER}","-v","{$SNMP.VERSION}"]'
              history: 90d
              valuemap:
                name: 'VPN status'
              tags:
                - tag: component
                  value: vpn
              trigger_prototypes:
                - uuid: 4cbe8943773a4218aa1d8e48edebc10e
                  expression: 'last(/FortiGate by SNMP/forti_vpn_status_v2.sh["-i","{HOST.IP}", "-c","{$SNMP_COMMUNITY}","-n","{#IFPHASE1NAME}","-a","{$SNMP.V3.PROTOCOL}","-A","{$SNMP.V3.PASSPHRASE}","-l","{$SNMP.V3.LEVEL}","-u","{$SNMP.V3.USER}","-v","{$SNMP.VERSION}"],#3)=3'
                  name: 'Tunnel {#IFPHASE1NAME} status is Disabled'
                  priority: INFO
                - uuid: 31f88b080fbb49f49026d17cd18ca388
                  expression: 'last(/FortiGate by SNMP/forti_vpn_status_v2.sh["-i","{HOST.IP}", "-c","{$SNMP_COMMUNITY}","-n","{#IFPHASE1NAME}","-a","{$SNMP.V3.PROTOCOL}","-A","{$SNMP.V3.PASSPHRASE}","-l","{$SNMP.V3.LEVEL}","-u","{$SNMP.V3.USER}","-v","{$SNMP.VERSION}"],#3)=1'
                  name: 'Tunnel {#IFPHASE1NAME} status is Down'
                  priority: HIGH
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  var discovered_items = JSON.parse(value);
                  var unique_names = {};
                  var filtered_items = [];
                  
                  discovered_items.forEach(function(item) {
                      var name = item['{#IFPHASE1NAME}'];  // Adjust to match the discovery macro for the name
                      if (!unique_names[name]) {
                          unique_names[name] = true;
                          filtered_items.push(item);  // Add the first occurrence of the name
                      }
                  });
                  
                  return JSON.stringify(filtered_items);
      tags:
        - tag: class
          value: network
        - tag: target
          value: fortigate
        - tag: target
          value: fortinet
      macros:
        - macro: '{$SNMP.TIMEOUT}'
          value: 5m
          description: 'The time interval for SNMP availability trigger.'
        - macro: '{$SNMP.V3.LEVEL}'
          value: authNoPriv
        - macro: '{$SNMP.V3.PASSPHRASE}'
          value: public
        - macro: '{$SNMP.V3.PROTOCOL}'
          value: MD5
        - macro: '{$SNMP.V3.USER}'
          value: public
        - macro: '{$SNMP.VERSION}'
          value: '3'
      valuemaps:
        - uuid: dcc48f63c8ae4048bcc067d46750818f
          name: 'VPN status'
          mappings:
            - value: '1'
              newvalue: Down
            - value: '2'
              newvalue: Up
            - value: '3'
              newvalue: Disabled
